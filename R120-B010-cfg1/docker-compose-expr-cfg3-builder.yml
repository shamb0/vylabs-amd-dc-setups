services:

  builder-solo-Qwen-Qwen3-Coder-30B-A3B-Instruct-triton:
    profiles: ["solo-builder-30b-262k-triton"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-builder-solo-Qwen3-Coder
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=0
      - SGLANG_USE_TRITON_FLASH_ATTN=1
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - MAX_MCP_OUTPUT_TOKENS=8000
    command: >
      python3 -m sglang.launch_server
      --model-path Qwen/Qwen3-Coder-30B-A3B-Instruct
      --tp 1 --host 0.0.0.0 --port 30000
      --mem-fraction-static 0.90
      --kv-cache-dtype bfloat16
      --context-length 262144
      --trust-remote-code
      --attention-backend triton
      --chunked-prefill-size 8192
      --tool-call-parser qwen3_coder

  solo-builder-Qwen-Qwen3-VL-30B:
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    profiles: ["solo-builder-Qwen-Qwen3-VL-30B"]
    container_name: vylabs-builder-solo-vl-30b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=0
      - SGLANG_USE_TRITON_FLASH_ATTN=1
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - MAX_MCP_OUTPUT_TOKENS=8000
    command: >
      python3 -m sglang.launch_server
      --model-path Qwen/Qwen3-VL-30B-A3B-Instruct
      --tp 1 --host 0.0.0.0 --port 30003
      --mem-fraction-static 0.85
      --kv-cache-dtype bfloat16
      --context-length 262144
      --trust-remote-code
      --attention-backend triton
      --chunked-prefill-size 8192

  builder-solo-Qwen-Qwen3-Coder-30B-A3B-Instruct-Aiter:
    profiles: ["solo-builder-30b-262k-aiter"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-builder-solo
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits: &rocm_ulimits
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices: &rocm_devices
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes: &rocm_volumes
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=1
      # [CRITICAL] Prevent Infinite Loop/Garbled Text at 262k
      - VLLM_USE_TRITON_FLASH_ATTN=0
    command: >
      python3 -m sglang.launch_server
      --model-path Qwen/Qwen3-Coder-30B-A3B-Instruct
      --tp 1 --host 0.0.0.0 --port 30000
      --mem-fraction-static 0.90
      --kv-cache-dtype bfloat16
      --context-length 262144
      --trust-remote-code
      --attention-backend aiter
      --chunked-prefill-size 32768
      --tool-call-parser qwen3_coder

