services:

  # =================================================================
  # OPTION E: The Powerhouse Architect (70B)
  # Llama 3.3 - 128k Context + Native Tools
  # Fits on single MI300X (192GB)
  # =================================================================
  architect-solo-70b-llama:
    profiles: ["solo-architect-70b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-70b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - HF_TOKEN=${HF_TOKEN}
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=1
      - NCCL_MIN_NCHANNELS=112
      # [CRITICAL] Enable Expandable Segments to avoid fragmentation with large context
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    command: >
      python3 -m sglang.launch_server
      --model-path meta-llama/Llama-3.3-70B-Instruct
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.92
      --kv-cache-dtype fp8_e5m2
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --tool-call-parser llama3

  # =================================================================
  # OPTION F: The Open Heavyweight (72B) - STABILIZED
  # Qwen 2.5 72B - Native BF16 Mode (High Stability)
  # Fits on MI300X: Weights (145GB) + 32k Cache (~20GB) = ~165GB / 192GB
  # =================================================================
# =================================================================
  # OPTION F: The Open Heavyweight (72B) - 128K FIXED
  # Qwen 2.5 72B - Native BF16 Mode (High Stability)
  # Fits on MI300X: Weights (144GB) + 128k Cache (40GB) = ~184GB / 192GB
  # =================================================================
  architect-solo-72b-qwen:
    profiles: ["solo-architect-72b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-72b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      # [CRITICAL FIX] Disable AITER to prevent dtype mismatch crash
      - SGLANG_USE_AITER=0
      - NCCL_MIN_NCHANNELS=112
      # Enable memory optimization for large context
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    command: >
      python3 -m sglang.launch_server
      --model-path Qwen/Qwen2.5-72B-Instruct
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.96
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend triton
      --tool-call-parser qwen25

  architect-solo-dr1-distill-32b:
    profiles: ["solo-architect-32b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-builder-solo
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      # AITER is mandatory for DeepSeek-R1 performance
      - SGLANG_USE_AITER=1
      - NCCL_MIN_NCHANNELS=112
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; print(urllib.request.urlopen('http://localhost:30000/health').read())\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 45s
    command: >
      python3 -m sglang.launch_server
      --model-path deepseek-ai/DeepSeek-R1-Distill-Qwen-32B
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --chunked-prefill-size 32768
      --tool-call-parser qwen

  # =================================================================
  # OPTION A: The Efficient Strategist (14B)
  # Distilled from Qwen 2.5 - Fast & Logic Heavy
  # =================================================================
  architect-solo-14b-qwen:
    profiles: ["solo-architect-14b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-14b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=1
      - NCCL_MIN_NCHANNELS=112
    command: >
      python3 -m sglang.launch_server
      --model-path deepseek-ai/DeepSeek-R1-Distill-Qwen-14B
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --tool-call-parser qwen

  # =================================================================
  # OPTION B: The Standard Bearer (8B)
  # Distilled from Llama 3.1 - Broad Compatibility
  # =================================================================
  architect-solo-8b-llama:
    profiles: ["solo-architect-8b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-8b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=1
    command: >
      python3 -m sglang.launch_server
      --model-path deepseek-ai/DeepSeek-R1-Distill-Llama-8B
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --tool-call-parser llama3

  # =================================================================
  # OPTION C: The Creative Multimodal (27B)
  # Gemma 3 - Vision & Text (Experimental on SGLang)
  # =================================================================
  architect-solo-27b-gemma:
    profiles: ["solo-architect-27b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-27b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      # [NOTE] Gemma 3 may require disabling AITER if kernels mismatch
      - SGLANG_USE_AITER=0
    command: >
      python3 -m sglang.launch_server
      --model-path google/gemma-3-27b-it
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
