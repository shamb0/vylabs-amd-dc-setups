services:

  architect-solo-dr1-distill-32b:
    profiles: ["solo-architect-32b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-builder-solo
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      # AITER is mandatory for DeepSeek-R1 performance      
      - SGLANG_USE_AITER=1
      - NCCL_MIN_NCHANNELS=112
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; print(urllib.request.urlopen('http://localhost:30000/health').read())\" || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 45s
    command: >
      python3 -m sglang.launch_server
      --model-path deepseek-ai/DeepSeek-R1-Distill-Qwen-32B
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --chunked-prefill-size 32768
      --tool-call-parser qwen

  # =================================================================
  # OPTION A: The Efficient Strategist (14B)
  # Distilled from Qwen 2.5 - Fast & Logic Heavy
  # =================================================================
  architect-solo-14b-qwen:
    profiles: ["solo-architect-14b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-14b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=1
      - NCCL_MIN_NCHANNELS=112
    command: >
      python3 -m sglang.launch_server
      --model-path deepseek-ai/DeepSeek-R1-Distill-Qwen-14B
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --tool-call-parser qwen

  # =================================================================
  # OPTION B: The Standard Bearer (8B)
  # Distilled from Llama 3.1 - Broad Compatibility
  # =================================================================
  architect-solo-8b-llama:
    profiles: ["solo-architect-8b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-8b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=1
    command: >
      python3 -m sglang.launch_server
      --model-path deepseek-ai/DeepSeek-R1-Distill-Llama-8B
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
      --attention-backend aiter
      --tool-call-parser llama3

  # =================================================================
  # OPTION C: The Creative Multimodal (27B)
  # Gemma 3 - Vision & Text (Experimental on SGLang)
  # =================================================================
  architect-solo-27b-gemma:
    profiles: ["solo-architect-27b"]
    image: lmsysorg/sglang:v0.5.5.post3-rocm700-mi30x
    container_name: vylabs-architect-27b
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      # [NOTE] Gemma 3 may require disabling AITER if kernels mismatch
      - SGLANG_USE_AITER=0
    command: >
      python3 -m sglang.launch_server
      --model-path google/gemma-3-27b-it
      --tp 1 --host 0.0.0.0 --port 30001
      --mem-fraction-static 0.80
      --kv-cache-dtype bfloat16
      --context-length 131072
      --trust-remote-code
