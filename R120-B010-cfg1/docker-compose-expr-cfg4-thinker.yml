services:
  solo-architect-qwen3-next-80b-80k:
    profiles: ["solo-architect-qwen3-next-80b-80k"]
    image: rocm/sgl-dev:v0.5.7-rocm700-mi30x-20260119
    container_name: architect-solo-qwen3-next-80b-80k
    ipc: host
    network_mode: host
    privileged: true
    cap_add: [SYS_PTRACE]
    security_opt: [seccomp=unconfined]
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: { soft: 1048576, hard: 1048576 }
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/scratch/huggingface:/root/.cache/huggingface
    environment:
      - SGLANG_ALLOW_OVERWRITE_LONGER_CONTEXT_LEN=1
      - HSA_NO_SCRATCH_RECLAIM=1
      - HF_HOME=/root/.cache/huggingface
      - GLOO_SOCKET_IFNAME=eth0
      - NCCL_SOCKET_IFNAME=eth0
      - SGLANG_USE_AITER=0
      - SGLANG_USE_TRITON_FLASH_ATTN=1
      - MAX_MCP_OUTPUT_TOKENS=64000
    # =========================================================================
    # EXPERIMENT A: Parser Enabled
    # 1. Applies ROCm Hot Patch
    # 2. Uses --reasoning-parser deepseek-r1 to extract thoughts
    # 3. Uses Speculative Decoding (MTP) for speed
    # =========================================================================
    command: >
      bash -c "
      python3 -m sglang.launch_server
      --model-path Qwen/Qwen3-Next-80B-A3B-Thinking
      --tp 1 --host 0.0.0.0 --port 30001
      --quantization fp8
      --kv-cache-dtype bfloat16
      --context-length 131072
      --mem-fraction-static 0.92
      --trust-remote-code
      --attention-backend triton
      --chunked-prefill-size 16384
      --reasoning-parser deepseek-r1
      "
